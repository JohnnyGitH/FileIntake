name: üöÄ Deploy to Cloud Run (UAT -> E2E -> PROD)

on:
 push:
    branches: ["master"]

jobs:
 build_and_deploy_uat:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        id-token: write
    
    env:
     PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
     REGION: ${{ vars.GCP_REGION }}
     AR_REPO: ${{ vars.GCP_AR_REPO }}
     SERVICE_NAME: ${{ vars.GCP_SERVICE_NAME }}
     SERVICE_NAME_UAT: ${{ vars.GCP_FILEINTAKE_UAT }}

    outputs:
      image_digest_ref: ${{ steps.digest.outputs.image_digest_ref }} # New

    steps:
     - name: üì• Checkout
       uses: actions/checkout@v4
    
     - name: üîê Authenticate to Google Cloud (WIF)
       uses: google-github-actions/auth@v2
       with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

     - name: ‚òÅÔ∏è Setup gcloud
       uses: google-github-actions/setup-gcloud@v2
    
     - name: Set gcloud project
       run: gcloud config set project "$PROJECT_ID"

     - name: üîë Configure Docker auth for Artifact Registry
       run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

     - name: üê≥ Build & push image (tag = commit SHA)
       id: build_push
       run: |
          IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/fileintake:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

     - name: üîí Resolve image digest (immutable)
       id: digest
       run: |
          DIGEST="$(gcloud artifacts docker images describe "$IMAGE" --format='get(image_summary.digest)')"
          IMAGE_DIGEST_REF="${IMAGE%@*}@${DIGEST}"
          echo "image_digest_ref=$IMAGE_DIGEST_REF" >> "$GITHUB_OUTPUT"
          echo "IMAGE_DIGEST_REF=$IMAGE_DIGEST_REF" >> "$GITHUB_ENV"

     - name: üöÄ Deploy to UAT # New steps
       run: |
          gcloud run deploy "$SERVICE_NAME_UAT" \
          --image "$IMAGE_DIGEST_REF" \
          --region "$REGION" \
          --platform managed \
          --allow-unauthenticated

 e2e_uat:
    runs-on: ubuntu-latest
    needs: build_and_deploy_uat

    env: 
      BASE_URL: ${{ secrets.FILEINTAKE_UAT_BASE_URL }}

    steps:
      - name: üì• Checkout E2E repo (public)
        uses: actions/checkout@v4
        with:
          repository: JohnnyGitH/FileIntake-E2E
          path: e2e
        
      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: üì¶ Install deps
        working-directory: e2e
        run: npm ci

      - name: üé≠ Install Playwright browsers
        working-directory: e2e
        run: npx playwright install --with-deps

      - name: ‚úÖ Run E2E against UAT
        working-directory: e2e
        run: npx playwright test
        env:
          BASE_URL: ${{ secrets.FILEINTAKE_UAT_BASE_URL }} # ??

 deploy_prod:
    runs-on: ubuntu-latest
    needs: [build_and_deploy_uat, e2e_uat]
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.GCP_REGION }}
      SERVICE_PROD: ${{ vars.GCP_SERVICE_NAME }}
      IMAGE_DIGEST_REF: ${{ needs.buid_and_deploy_uat.outputs.image_digest_ref }}

    steps:
      - name: üîê Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: ‚òÅÔ∏è Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set gcloud project
        run: gcloud config set project "$PROJECT_ID"

      - name: üöÄ Promote to PROD (same image digest)
        run: |
          gcloud run deploy "$SERVICE_PROD" \
            --image "$IMAGE_DIGEST_REF" \
            --region "$REGION" \
            --platform managed \
            --allow-unauthenticated

  
          
        
